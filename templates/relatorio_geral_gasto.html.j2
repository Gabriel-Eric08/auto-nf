<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Geral de Gastos</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* Estilos CSS: Mantenha seus estilos aqui */
        body { background-color: #f9f9f9; }
        .navbar-custom { background-color: #ffffff; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); border-bottom: 3px solid #d81b60; }
        .btn-custom { background-color: #d81b60; color: white; border: none; }
        .btn-custom:hover { background-color: #ff69b4; color: white; }
        .btn-acao { background-color: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 5px; display: inline-block; }
        .table-custom th, .table-custom td { border: 1px solid #d81b60; vertical-align: middle; }
        .table-custom th { background-color: #d81b60; color: white; }

        @media print {
            .no-print, .navbar-custom { display: none !important; }
            body { background-color: white !important; }
            .container { margin-top: 0 !important; padding: 10px; }
            .table-custom { -webkit-print-color-adjust: exact; color-adjust: exact; width: 100% !important; border-collapse: collapse; }
            .table-custom th { font-size: 8pt; }
            .table-custom td { font-size: 7pt; }
            h3::before { content: "Relatório Geral de Gastos - Contrato: " attr(data-contrato) " | Lote: " attr(data-lote); display: block; font-size: 1rem; font-weight: bold; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 2px solid #333; }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-custom no-print">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Menu</a>
    </div>
</nav>
<div class="container mt-5">
    <div class="card card-custom no-print">
        <div class="card-header bg-white">
            <h5 class="card-title" style="color: #d81b60;">Filtro de Relatório Geral de Gastos</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="contratoSelect" class="form-label">Contrato</label>
                    <select class="form-select" id="contratoSelect">
                        <option selected disabled value="">Selecione o Contrato</option>
                        {% for contrato in contratos %}
                        <option value="{{ contrato.id }}" data-nome="{{ contrato.nome }}">{{ contrato.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="loteSelect" class="form-label">Lote</label>
                    <select class="form-select" id="loteSelect" disabled>
                        <option selected disabled value="">Selecione o Lote</option>
                    </select>
                </div>
            </div>
            <div class="d-grid gap-2 d-md-flex justify-content-md-start mt-3">
                <button type="button" class="btn btn-custom" id="selecionarBtn" disabled>Gerar Relatório</button>
                <button type="button" onclick="window.print()" class="btn-acao" id="imprimirBtn" disabled>
                    <i class="material-icons me-1" style="vertical-align: middle;">print</i> Imprimir/Salvar PDF
                </button>
            </div>
        </div>
    </div>

    <h3 class="mt-5" style="color: #d81b60;" id="tituloRelatorio" data-contrato="" data-lote="">Relatório de Gastos Detalhado</h3>
    <div class="table-responsive">
        <table class="table table-striped table-hover table-custom">
            <thead>
                <tr>
                    <th scope="col">Cód. Prod.</th>
                    <th scope="col">Descrição</th>
                    <th scope="col">Lote</th>
                    <th scope="col">Qtd. Total</th>
                    <th scope="col">Valor Unt.</th>
                    <th scope="col">Valor Total</th>
                    <th scope="col">Qtd. Gasta</th>
                    <th scope="col">Valor Gasto</th>
                    <th scope="col">Saldo Qtd.</th>
                    <th scope="col">Saldo Valor</th>
                </tr>
            </thead>
            <tbody id="tabela-corpo">
                <tr><td colspan="10" class="text-center">Selecione o Contrato e o Lote e clique em "Gerar Relatório".</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Mapa de Lotes: {contrato_id: [{id: 1, nome_lote: 'Lote A', ano: '2024', ...}]}
    // Quando convertido para JSON, as chaves numéricas (IDs) tornam-se STRINGS.
    const lotesMap = {{ lotes_map | tojson }};

    document.addEventListener('DOMContentLoaded', function() {
        const contratoSelect = document.getElementById('contratoSelect');
        const loteSelect = document.getElementById('loteSelect');
        const selecionarBtn = document.getElementById('selecionarBtn');
        const imprimirBtn = document.getElementById('imprimirBtn');
        const tabelaCorpo = document.getElementById('tabela-corpo');
        const tituloRelatorio = document.getElementById('tituloRelatorio');

        function resetCampos() {
            loteSelect.innerHTML = '<option selected disabled value="">Selecione o Lote</option>';
            loteSelect.disabled = true;
            selecionarBtn.disabled = true;
            imprimirBtn.disabled = true;
            tabelaCorpo.innerHTML = '<tr><td colspan="10" class="text-center">Selecione o Contrato e o Lote e clique em "Gerar Relatório".</td></tr>';
            tituloRelatorio.setAttribute('data-contrato', '');
            tituloRelatorio.setAttribute('data-lote', '');
        }

        // 1. EVENTO DE MUDANÇA NO CONTRATO
        contratoSelect.addEventListener('change', async function() {
            // Pega o ID como STRING do value. Esta é a chave correta no lotesMap.
            const contratoIdString = this.value; 
            
            resetCampos();
            
            // Busca lotes usando a STRING do ID.
            const lotes = lotesMap[contratoIdString] || []; 
            
            if (lotes.length > 0) {
                loteSelect.disabled = false;
                lotes.forEach(lote => {
                    const option = document.createElement('option');
                    // O value é o nome_lote puro, que o Flask espera no POST.
                    option.value = lote.nome_lote; 
                    option.textContent = `Lote ${lote.nome_lote} (${lote.ano || 'S/A'})`;
                    loteSelect.appendChild(option);
                });
            } else {
                loteSelect.innerHTML = '<option selected disabled value="">Nenhum lote associado.</option>';
                console.warn(`LotesMap: Nenhum lote encontrado para o Contrato ID: ${contratoIdString}.`);
            }
        });

        // 2. EVENTO DE MUDANÇA NO LOTE (Ativar Botão)
        loteSelect.addEventListener('change', function() {
            selecionarBtn.disabled = false;
            imprimirBtn.disabled = true;
            tabelaCorpo.innerHTML = '<tr><td colspan="10" class="text-center">Clique em "Gerar Relatório" para carregar os dados.</td></tr>'; 
        });


        // 3. Lógica para carregar os dados do Relatório
        selecionarBtn.addEventListener('click', async function() {
            // Obtem o NOME do Contrato do atributo data-nome.
            const selectedContratoOption = contratoSelect.options[contratoSelect.selectedIndex];
            const contratoNome = selectedContratoOption.getAttribute('data-nome');
            const loteNome = loteSelect.value; // Nome puro do lote (String)
            
            if (!contratoNome || !loteNome) {
                alert('Por favor, selecione um Contrato e um Lote primeiro.');
                return;
            }

            console.log("DEBUG F/E: Contrato ENVIADO (Nome):", contratoNome);
            console.log("DEBUG F/E: Lote ENVIADO (Nome Puro):", loteNome);

            selecionarBtn.disabled = true;
            selecionarBtn.textContent = 'Gerando...';
            imprimirBtn.disabled = true;
            tabelaCorpo.innerHTML = ''; 

            try {
                const response = await fetch('/relatorio', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contrato: contratoNome, lote: loteNome }) 
                });
                
                const jsonResponse = await response.json();

                if (response.ok) {
                    if (jsonResponse.status === 'Relatório geral de gasto gerado com sucesso!' && jsonResponse.data) {
                        const data = jsonResponse.data;
                        
                        if (data.length > 0) {
                            data.forEach(item => {
                                const saldoQtd = item['Qtd.Total'] - item['Qtd. Gasta'];
                                const saldoValor = item['Valor Total'] - item['Valor Gasto'];

                                const novaLinha = document.createElement('tr');
                                novaLinha.innerHTML = `
                                    <td>${item['Cód. Prod.']}</td>
                                    <td>${item['Desc.']}</td>
                                    <td>${item['Lote']}</td>
                                    <td>${item['Qtd.Total']}</td>
                                    <td>R$ ${parseFloat(item['Valor Unt']).toFixed(2)}</td>
                                    <td>R$ ${parseFloat(item['Valor Total']).toFixed(2)}</td>
                                    <td>${item['Qtd. Gasta']}</td>
                                    <td>R$ ${parseFloat(item['Valor Gasto']).toFixed(2)}</td>
                                    <td>${saldoQtd}</td>
                                    <td>R$ ${saldoValor.toFixed(2)}</td>
                                `;
                                tabelaCorpo.appendChild(novaLinha);
                            });
                            
                            tituloRelatorio.setAttribute('data-contrato', contratoNome);
                            tituloRelatorio.setAttribute('data-lote', loteNome);
                            imprimirBtn.disabled = false; 

                        } else {
                            tabelaCorpo.innerHTML = '<tr><td colspan="10" class="text-center">Nenhum dado encontrado para o contrato e lote selecionados.</td></tr>';
                        }
                    } else {
                        const errorMessage = jsonResponse.erro || 'Resposta de sucesso inesperada. Tente novamente.';
                        alert(`Erro interno: ${errorMessage}`);
                        tabelaCorpo.innerHTML = `<tr><td colspan="10" class="text-center" style="color: red;">ERRO: ${errorMessage}</td></tr>`;
                    }
                } else {
                    const errorMessage = jsonResponse.erro || `Erro HTTP ${response.status}: Falha ao processar relatório.`;
                    alert(`Erro na API: ${errorMessage}`);
                    tabelaCorpo.innerHTML = `<tr><td colspan="10" class="text-center" style="color: red;">ERRO: ${errorMessage}</td></tr>`;
                }
            } catch (error) {
                console.error('Erro de conexão ou JSON inválido:', error);
                alert('Erro crítico: Verifique o console ou o terminal do servidor para o erro 500.');
                tabelaCorpo.innerHTML = '<tr><td colspan="10" class="text-center" style="color: red;">ERRO CRÍTICO (500 ou Rede): Falha ao processar.</td></tr>';
            } finally {
                selecionarBtn.disabled = false;
                selecionarBtn.textContent = 'Gerar Relatório';
            }
        });
    });
</script>

</body>
</html>