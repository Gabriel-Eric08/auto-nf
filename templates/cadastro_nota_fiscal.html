<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Cadastro de Nota Fiscal</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    body {
      background-color: #f9f9f9;
    }
    .navbar-custom {
      background-color: #ffffff;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      border-bottom: 3px solid #d81b60;
    }
    .navbar-custom.nav-link,
    .navbar-custom.navbar-brand {
      color: #d81b60;
      font-weight: bold;
    }
    .navbar-custom.nav-link:hover {
      color: #ff69b4;
    }
    .dropdown-menu {
      border: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      background-color: #ffffff;
    }
    .dropdown-item {
      color: #d81b60;
      transition: background-color 0.3s ease;
    }
    .dropdown-item:hover {
      background-color: #fff0f5;
    }
    .nav-item.dropdown:hover .dropdown-menu {
      display: block;
    }
    .card-custom {
      border: 1px solid #d81b60;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .btn-custom {
      background-color: #d81b60;
      color: white;
      border: none;
    }
    .btn-custom:hover {
      background-color: #ff69b4;
      color: white;
    }
    .btn-salvar {
      background-color: #4a148c;
      color: white;
      border: none;
    }
    .btn-salvar:hover {
      background-color: #7b1fa2;
      color: white;
    }
    .table-custom th, .table-custom td {
      border: 1px solid #d81b60;
      vertical-align: middle;
    }
    .table-custom th {
      background-color: #d81b60;
      color: white;
    }
    .table-custom tr:nth-child(even) {
      background-color: #fce4ec;
    }
    .table-custom tr:nth-child(odd) {
      background-color: #fff0f5;
    }
    .form-control[readonly] {
      background-color: #e9ecef;
      opacity: 1;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('home.home') }}">Secretaria da Mulher</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              Contratos
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{{ url_for('contrato.contratos_page') }}">Cadastro contrato</a></li>
              <li><a class="dropdown-item" href="{{ url_for('contrato_produto.contrato_produto_page') }}">Cadastro nota de empenho</a></li>
              <li><a class="dropdown-item" href="{{ url_for('contrato_produto.visualizar_contrato_produto_page') }}">Visualizar notas de empenho</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              Notas Fiscais
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{{ url_for('nota_fiscal.cadastro_nota_fiscal_page') }}">Cadastrar nota fiscal</a></li>
              <li><a class="dropdown-item" href="{{ url_for('nota_fiscal.visualizar_notas_fiscais_page') }}">Visualizar notas fiscais</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              Controle
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{{ url_for('controle_gasto.controle_gasto_page') }}">Controle gastos</a></li>
            </ul>
          </li>
        </ul>

        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
              aria-expanded="false">
              <span class="material-icons">account_circle</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#">Trocar de conta</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="card card-custom">
      <div class="card-header bg-white">
        <h5 class="card-title" style="color:#d81b60;">Cadastro de Nota Fiscal</h5>
      </div>
      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label for="nomeNf" class="form-label">Nome da Nota Fiscal</label>
            <input type="text" class="form-control" id="nomeNf" placeholder="Ex: NF-00123456" required>
          </div>
          <div class="col-md-4">
            <label for="dataEmissao" class="form-label">Data de Emiss√£o</label>
            <input type="date" class="form-control" id="dataEmissao" required>
          </div>
          <div class="col-md-4">
            <label for="selectContrato" class="form-label">Contrato</label>
            <select class="form-select" id="selectContrato" required>
              <option selected disabled value="">Selecione um contrato...</option>
              {% for contrato in contratos %}
              <option value="{{ contrato.id }}" data-tipo="{{ contrato.tipo }}">{{ contrato.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label for="selectLote" class="form-label">Lote</label>
            <div class="input-group">
              <select class="form-select" id="selectLote" disabled required>
                <option selected disabled value="">Selecione um lote...</option>
              </select>
              <button class="btn btn-custom" type="button" id="btnSelecionar" disabled>Selecionar Produtos</button>
            </div>
          </div>
          <div class="col-md-4" hidden>
            <label for="casaLote" class="form-label">Casa do Lote</label>
            <input type="text" class="form-control" id="casaLote" readonly>
          </div>
          <div class="col-md-4">
            <label for="tipoContrato" class="form-label">Tipo do Contrato</label>
            <input type="text" class="form-control" id="tipoContrato" readonly>
          </div>
        </div>
        <hr>
        <div class="row g-3">
          <div class="col-md-3">
            <label for="selectProduto" class="form-label">C√≥digo do Produto</label>
            <select class="form-select" id="selectProduto" disabled>
              <option selected disabled value="">Selecione um produto...</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="descricaoProduto" class="form-label">Descri√ß√£o</label>
            <input type="text" class="form-control" id="descricaoProduto" readonly>
          </div>
          <div class="col-md-3">
            <label for="quantidade" class="form-label">Quantidade Recebida</label>
            <input type="number" class="form-control" id="quantidade" min="1" value="1">
          </div>
          <div class="col-md-3">
            <label for="valorUnitario" class="form-label">Valor Unit√°rio NF</label>
            <input type="number" class="form-control" id="valorUnitario" min="0" step="0.01" value="0.00">
          </div>
        </div>
        <div class="d-grid gap-2 d-md-flex justify-content-md-start mt-3">
          <button type="button" class="btn btn-custom" id="adicionarItem" disabled>Adicionar Item</button>
          <button type="button" class="btn btn-salvar" id="salvarItens" disabled>Salvar Nota</button>
        </div>
      </div>
    </div>

    <h3 class="mt-5" style="color:#d81b60;">Produtos na Nota Fiscal</h3>
    <div class="table-responsive">
      <table class="table table-striped table-hover table-custom">
        <thead>
          <tr>
            <th scope="col">C√≥digo do Produto</th>
            <th scope="col">Descri√ß√£o</th>
            <th scope="col">Quantidade</th>
            <th scope="col">Valor Unit√°rio NF</th>
            <th scope="col">Valor Total</th>
            <th scope="col">A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="tabela-produtos">
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // üí° Vari√°vel global que o backend enviou via Jinja
    const lotesMap = {{ lotes_map|tojson }};
    const produtos_para_salvar = [];

    const btnSelecionar = document.getElementById('btnSelecionar');
    const selectContrato = document.getElementById('selectContrato');
    const selectLote = document.getElementById('selectLote');
    const casaLote = document.getElementById('casaLote');
    const tipoContrato = document.getElementById('tipoContrato');
    const selectProduto = document.getElementById('selectProduto');
    const descricaoProduto = document.getElementById('descricaoProduto');
    const valorUnitario = document.getElementById('valorUnitario');
    const btnAdicionar = document.getElementById('adicionarItem');
    const btnSalvar = document.getElementById('salvarItens');
    const tabelaCorpo = document.getElementById('tabela-produtos');

    // Fun√ß√£o auxiliar para resetar os campos de lote e produto
    function resetLoteEProduto() {
      selectLote.innerHTML = '<option selected disabled value="">Selecione um lote...</option>';
      selectLote.disabled = true;
      casaLote.value = '';
      tipoContrato.value = '';
      selectProduto.innerHTML = '<option selected disabled value="">Selecione um produto...</option>';
      selectProduto.disabled = true;
      descricaoProduto.value = '';
      valorUnitario.value = '0.00';
      document.getElementById('quantidade').value = '1';
      btnSelecionar.disabled = true;
      btnAdicionar.disabled = true;
    }

    // 1. EVENTO DE MUDAN√áA NO CONTRATO
    selectContrato.addEventListener('change', function() {
      const contratoId = this.value;
      const selectedOption = this.options[this.selectedIndex];

      // Resetar tudo abaixo
      resetLoteEProduto();
      produtos_para_salvar.length = 0;
      tabelaCorpo.innerHTML = '';
      btnSalvar.disabled = true;

      // Exibir Tipo do Contrato
      tipoContrato.value = selectedOption.dataset.tipo || 'N/A';

      // Carregar e preencher Lotes
      const lotes = lotesMap[contratoId] || [];

      if (lotes.length > 0) {
        selectLote.disabled = false;
        lotes.forEach(lote => {
          const option = document.createElement('option');
          option.value = lote.id;

          // üõë CORRE√á√ÉO AQUI: Remove "Lote" fixo
          option.textContent = `${lote.nome_lote} (${lote.ano})`;

          option.setAttribute('data-casa', lote.casa);
          selectLote.appendChild(option);
        });
      } else {
        selectLote.innerHTML = '<option selected disabled value="">Nenhum lote associado.</option>';
      }
    });

    // 2. EVENTO DE MUDAN√áA NO LOTE ‚¨ÖÔ∏è ATUALIZADO
    selectLote.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const casa = selectedOption.dataset.casa;

      // Atualizar campo Casa
      casaLote.value = casa || '';

      // Ativar bot√£o de Selecionar Produtos (agora por Contrato + Lote)
      btnSelecionar.disabled = false;

      // Limpar lista de produtos da NF e lista para salvar
      produtos_para_salvar.length = 0;
      tabelaCorpo.innerHTML = '';
      btnSalvar.disabled = true;

      // Resetar campos de Produto
      selectProduto.innerHTML = '<option selected disabled value="">Selecione um produto...</option>';
      selectProduto.disabled = true;
      descricaoProduto.value = '';
      valorUnitario.value = '0.00';
    });

    // 3. EVENTO DE CLIQUE PARA SELECIONAR PRODUTOS (AJAX) ‚¨ÖÔ∏è ATUALIZADO
    btnSelecionar.addEventListener('click', async function() {
      const contratoId = selectContrato.value;
      const loteId = selectLote.value;

      if (!contratoId || !loteId) {
        alert('Por favor, selecione um contrato e um lote primeiro.');
        return;
      }

      btnSelecionar.textContent = 'Carregando...';
      btnSelecionar.disabled = true;
      selectProduto.disabled = true;

      try {
        // Rota AJAX ATUALIZADA para incluir o LOTE ID
        const url = `/contrato/produtos_por_contrato_lote/${contratoId}/${loteId}`;
        const response = await fetch(url);

        if (!response.ok) {
          const errorData = await response.json();
          alert('Erro ao carregar produtos: ' + errorData.message);
          return;
        }

        const produtos = await response.json();

        selectProduto.innerHTML = '<option selected disabled value="">Selecione um produto...</option>';
        if (produtos.length === 0) {
          alert('Nenhum produto cadastrado para este Contrato/Lote.');
          selectProduto.innerHTML = '<option selected disabled value="">Nenhum produto dispon√≠vel.</option>';
        } else {
          produtos.forEach(produto => {
            const option = document.createElement('option');
            option.value = produto.id;
            option.textContent = produto.nome;
            option.setAttribute('data-descricao', produto.descricao);
            option.setAttribute('data-preco', produto.preco_unitario);
            selectProduto.appendChild(option);
          });
          selectProduto.disabled = false;
        }

        btnAdicionar.disabled = produtos.length === 0;

      } catch (error) {
        console.error('Erro na requisi√ß√£o:', error);
        alert('Erro ao carregar produtos. Tente novamente.');
      } finally {
        btnSelecionar.textContent = 'Selecionar Produtos';
        // O bot√£o de selecionar produtos √© reativado
        btnSelecionar.disabled = false;
      }
    });

    // 4. EVENTO DE MUDAN√áA NO PRODUTO
    selectProduto.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      if (selectedOption.value) {
        descricaoProduto.value = selectedOption.dataset.descricao;
        // Define o pre√ßo unit√°rio do Contrato como valor inicial, mas permite edi√ß√£o
        valorUnitario.value = parseFloat(selectedOption.dataset.preco).toFixed(2);
      } else {
        descricaoProduto.value = "";
        valorUnitario.value = "0.00";
      }
    });

    // 5. EVENTO DE ADICIONAR ITEM NA TABELA
    document.getElementById('adicionarItem').addEventListener('click', function() {
      const produtoId = selectProduto.value;
      const codigoProduto = selectProduto.options[selectProduto.selectedIndex].textContent;
      const descricao = descricaoProduto.value;
      // Pega a quantidade e o valor unit√°rio digitados pelo usu√°rio
      const quantidade = parseFloat(document.getElementById('quantidade').value);
      const valorUnitarioNF = parseFloat(document.getElementById('valorUnitario').value); // Valor da NF
      const valorUnitarioOriginal = parseFloat(selectProduto.options[selectProduto.selectedIndex].dataset.preco);

      // Valida√ß√µes
      if (!produtoId || isNaN(quantidade) || isNaN(valorUnitarioNF) || quantidade <= 0 || valorUnitarioNF <= 0) {
        alert('Por favor, preencha todos os campos do produto corretamente. O valor unit√°rio da NF deve ser maior que zero.');
        return;
      }

      // Evita duplicatas
      if (produtos_para_salvar.some(p => p.produto_id === parseInt(produtoId))) {
        alert('Este produto j√° foi adicionado √† nota fiscal. Remova-o antes de tentar adicionar novamente.');
        return;
      }

      const valorTotal = (quantidade * valorUnitarioNF).toFixed(2);

      const novaLinha = document.createElement('tr');

      // Adicionar bot√£o de exclus√£o
      novaLinha.innerHTML = `
        <td>${codigoProduto}</td>
        <td>${descricao}</td>
        <td>${quantidade}</td>
        <td>R$${valorUnitarioNF.toFixed(2)}</td>
        <td>R$${valorTotal}</td>
        <td><button class="btn btn-sm btn-danger remover-item" data-produto-id="${produtoId}">Remover</button></td>
      `;

      tabelaCorpo.appendChild(novaLinha);

      produtos_para_salvar.push({
        produto_id: parseInt(produtoId),
        quantidade_recebida: quantidade,
        preco_unitario_nf: valorUnitarioNF
      });

      // Adiciona listener para o novo bot√£o de remover
      novaLinha.querySelector('.remover-item').addEventListener('click', function() {
        const idToRemove = parseInt(this.dataset.produtoId);
        const indexToRemove = produtos_para_salvar.findIndex(p => p.produto_id === idToRemove);

        if (indexToRemove > -1) {
          produtos_para_salvar.splice(indexToRemove, 1);
        }
        novaLinha.remove();

        // Desabilita o bot√£o salvar se a lista ficar vazia
        if (produtos_para_salvar.length === 0) {
          btnSalvar.disabled = true;
        }
      });

      // Limpar campos de entrada do item
      selectProduto.value = "";
      descricaoProduto.value = "";
      document.getElementById('quantidade').value = '1';
      valorUnitario.value = "0.00";

      btnSalvar.disabled = false;
    });

    // 6. EVENTO DE SALVAR NOTA FISCAL (AJAX POST) ‚¨ÖÔ∏è CORRE√á√ÉO CR√çTICA
    document.getElementById('salvarItens').addEventListener('click', async function() {
      const nomeNf = document.getElementById('nomeNf').value.trim();
      const dataEmissao = document.getElementById('dataEmissao').value;
      const contratoId = document.getElementById('selectContrato').value;
      const loteId = document.getElementById('selectLote').value; // üí° PEGA O LOTE ID

      if (!nomeNf || !dataEmissao || !contratoId || !loteId) {
        alert('Por favor, preencha o nome da NF, a data, e selecione o Contrato e o Lote.');
        return;
      }

      if (produtos_para_salvar.length === 0) {
        alert('N√£o h√° produtos para salvar na nota fiscal.');
        return;
      }

      btnSalvar.disabled = true;
      btnSalvar.textContent = 'Salvando...';

      const dataToSend = {
        nome_nf: nomeNf,
        data_emissao: dataEmissao,
        contrato_id: parseInt(contratoId),
        lote_id: parseInt(loteId), // üí° ENVIA O LOTE ID PARA O BACKEND
        produtos: produtos_para_salvar
      };

      try {
        const response = await fetch('/notafiscal/cadastro', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(dataToSend)
        });

        const result = await response.json();

        if (response.ok) {
          alert('Nota Fiscal e produtos salvos com sucesso!');
          // Resetar formul√°rio ap√≥s sucesso
          window.location.reload();
        } else {
          console.error('Erro ao salvar a nota fiscal:', result.message);
          alert(`Erro ao salvar a nota fiscal: ${result.message}`);
        }
      } catch (error) {
        console.error('Erro na requisi√ß√£o:', error);
        alert('Erro de conex√£o com o servidor.');
      } finally {
        btnSalvar.disabled = false;
        btnSalvar.textContent = 'Salvar Nota';
      }
    });
  </script>
</body>
</html>
